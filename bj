#!/bin/bash
#
# bj - Minimal Bullet Journal
# Version: 1.0.0

set -euo pipefail

BJ_DIR="${BJ_HOME:-$HOME/bj}"
CACHE_FILE="$BJ_DIR/.current_date"

mkdir -p "$BJ_DIR"

# Get current working date
get_current_date() {
    if [[ -f "$CACHE_FILE" ]]; then
        cat "$CACHE_FILE"
    else
        date +%Y-%m-%d
    fi
}

# Set current working date
set_current_date() {
    echo "$1" > "$CACHE_FILE"
}

CURRENT_DATE=$(get_current_date)
FILE="$BJ_DIR/$CURRENT_DATE.md"

# Create file if needed
if [[ ! -f "$FILE" ]]; then
    echo "# $CURRENT_DATE" > "$FILE"
    echo "" >> "$FILE"
fi

# Portable sed in-place
sed_inplace() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "$@"
    else
        sed -i "$@"
    fi
}

# List tasks (without line numbers)
list() {
    # Show date header: MMDD DAY
    local date_header
    if [[ "$OSTYPE" == "darwin"* ]]; then
        date_header=$(date -j -f "%Y-%m-%d" "$CURRENT_DATE" "+%m%d %a" | tr '[:lower:]' '[:upper:]')
    else
        date_header=$(date -d "$CURRENT_DATE" "+%m%d %a" | tr '[:lower:]' '[:upper:]')
    fi
    echo "$date_header"

    local entries
    entries=$(grep -v "^#" "$FILE" | grep -v "^$" || true)

    if [[ -z "$entries" ]]; then
        echo "No tasks."
    else
        # Strip leading spaces for consistent alignment
        echo "$entries" | sed 's/^[[:space:]]*//'
    fi
}

# Add task
add() {
    local bullet="$1"
    shift
    local text="$*"

    echo "$bullet  $text" >> "$FILE"
    echo "$bullet  $text"
}

# Change bullet
change() {
    local new_bullet="$1"
    local num="$2"

    # Get non-empty, non-comment lines
    local lines
    lines=$(grep -v "^#" "$FILE" | grep -v "^$" || true)

    local total
    total=$(echo "$lines" | wc -l | tr -d ' ')

    if [[ $num -lt 1 ]] || [[ $num -gt $total ]]; then
        echo "Error: Task $num not found (1-$total)"
        exit 1
    fi

    # Get actual line number in file
    local line_nums
    line_nums=$(grep -n -v "^#" "$FILE" | grep -v ":$" | cut -d: -f1)
    local actual_line
    actual_line=$(echo "$line_nums" | sed -n "${num}p")

    # Change the bullet - strip leading spaces and ensure consistent format
    sed_inplace "${actual_line}s/^[[:space:]]*[.!xoaw><-]/$new_bullet/" "$FILE"

    local new_line
    new_line=$(sed -n "${actual_line}p" "$FILE")
    echo "$new_line"
}

# Delete task
delete() {
    local num="$1"

    local lines
    lines=$(grep -v "^#" "$FILE" | grep -v "^$" || true)

    local total
    total=$(echo "$lines" | wc -l | tr -d ' ')

    if [[ $num -lt 1 ]] || [[ $num -gt $total ]]; then
        echo "Error: Task $num not found (1-$total)"
        exit 1
    fi

    local line_nums
    line_nums=$(grep -n -v "^#" "$FILE" | grep -v ":$" | cut -d: -f1)
    local actual_line
    actual_line=$(echo "$line_nums" | sed -n "${num}p")

    local deleted
    deleted=$(sed -n "${actual_line}p" "$FILE")

    sed_inplace "${actual_line}d" "$FILE"
    echo "Deleted: $deleted"
}

# Navigate to date
navigate() {
    local date_arg="$1"
    local target_date

    if [[ "$date_arg" == "today" ]]; then
        target_date=$(date +%Y-%m-%d)
    elif [[ "$date_arg" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        # Full date: 2025-03-15
        target_date="$date_arg"
    elif [[ "$date_arg" =~ ^[0-9]{2}-[0-9]{2}$ ]]; then
        # Month-Day: 12-25
        local year
        year=$(date +%Y)
        target_date="$year-$date_arg"
    else
        echo "Error: Invalid date format"
        echo "Usage: bj date today | bj date MM-DD | bj date YYYY-MM-DD"
        echo "Examples: bj date today, bj date 12-25, bj date 2025-12-25"
        exit 1
    fi

    # Validate date (basic check)
    if ! date -j -f "%Y-%m-%d" "$target_date" &>/dev/null && ! date -d "$target_date" &>/dev/null; then
        echo "Error: Invalid date '$target_date'"
        exit 1
    fi

    set_current_date "$target_date"

    local target_file="$BJ_DIR/$target_date.md"
    if [[ ! -f "$target_file" ]]; then
        echo "# $target_date" > "$target_file"
        echo "" >> "$target_file"
    fi

    # Update FILE variable for list function
    FILE="$target_file"
    CURRENT_DATE="$target_date"

    # Show date header: MMDD DAY
    local date_header
    if [[ "$OSTYPE" == "darwin"* ]]; then
        date_header=$(date -j -f "%Y-%m-%d" "$target_date" "+%m%d %a" | tr '[:lower:]' '[:upper:]')
    else
        date_header=$(date -d "$target_date" "+%m%d %a" | tr '[:lower:]' '[:upper:]')
    fi
    echo "$date_header"

    local entries
    entries=$(grep -v "^#" "$target_file" | grep -v "^$" || true)

    if [[ -z "$entries" ]]; then
        echo "No tasks."
    else
        # Strip leading spaces for consistent alignment
        echo "$entries" | sed 's/^[[:space:]]*//'
    fi
}

# Migrate tasks
migrate() {
    local target_date

    # Get tomorrow's date
    if [[ "$OSTYPE" == "darwin"* ]]; then
        target_date=$(date -v+1d -j -f "%Y-%m-%d" "$CURRENT_DATE" +%Y-%m-%d)
    else
        target_date=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
    fi

    # Create target file if needed
    local target_file="$BJ_DIR/$target_date.md"
    if [[ ! -f "$target_file" ]]; then
        echo "# $target_date" > "$target_file"
        echo "" >> "$target_file"
    fi

    # Find incomplete tasks (., !, w, <)
    local incomplete
    incomplete=$(grep -E "^[[:space:]]*[.!w<]" "$FILE" || true)

    if [[ -z "$incomplete" ]]; then
        echo "No incomplete tasks to migrate."
        exit 0
    fi

    echo "Migrating incomplete tasks to $target_date:"
    echo "$incomplete"
    echo ""

    # Change bullets to > (migrated) and append to target file
    local migrated
    migrated=$(echo "$incomplete" | sed 's/^[[:space:]]*[.!w<]/>/')
    echo "$migrated" >> "$target_file"

    # Update current file - change incomplete to migrated
    while IFS= read -r line; do
        if [[ -n "$line" ]]; then
            local escaped_line
            escaped_line=$(printf '%s\n' "$line" | sed 's/[]\/$*.^[]/\\&/g')
            # Strip leading spaces and replace bullet with >
            local text_part="${line#*[.!w<] }"
            sed_inplace "s/^${escaped_line}$/> ${text_part}/" "$FILE"
        fi
    done <<< "$incomplete"

    echo "Migrated to $target_date!"
}

# Schedule task to specific date
schedule() {
    local num="$1"
    local date_arg="$2"
    local target_date

    # Parse date argument
    if [[ "$date_arg" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        # Full date: 2025-03-15
        target_date="$date_arg"
    elif [[ "$date_arg" =~ ^[0-9]{2}-[0-9]{2}$ ]]; then
        # Month-Day: 12-25
        local year
        year=$(date +%Y)
        target_date="$year-$date_arg"
    else
        echo "Error: Invalid date format"
        echo "Usage: bj schedule [n] [MM-DD | YYYY-MM-DD]"
        exit 1
    fi

    # Validate date
    if ! date -j -f "%Y-%m-%d" "$target_date" &>/dev/null && ! date -d "$target_date" &>/dev/null; then
        echo "Error: Invalid date '$target_date'"
        exit 1
    fi

    # Get the task
    local lines
    lines=$(grep -v "^#" "$FILE" | grep -v "^$" || true)

    local total
    total=$(echo "$lines" | wc -l | tr -d ' ')

    if [[ $num -lt 1 ]] || [[ $num -gt $total ]]; then
        echo "Error: Task $num not found (1-$total)"
        exit 1
    fi

    # Get actual line number in file
    local line_nums
    line_nums=$(grep -n -v "^#" "$FILE" | grep -v ":$" | cut -d: -f1)
    local actual_line
    actual_line=$(echo "$line_nums" | sed -n "${num}p")

    # Get the task text
    local task_line
    task_line=$(sed -n "${actual_line}p" "$FILE")
    local task_text
    task_text=$(echo "$task_line" | sed -E 's/^[[:space:]]*[.!xoaw><-][[:space:]]*//')

    # Create target file if needed
    local target_file="$BJ_DIR/$target_date.md"
    if [[ ! -f "$target_file" ]]; then
        echo "# $target_date" > "$target_file"
        echo "" >> "$target_file"
    fi

    # Add scheduled task to target date
    echo "<  $task_text" >> "$target_file"

    # Change bullet to < in current file
    sed_inplace "${actual_line}s/^[[:space:]]*[.!xoaw><-]/</" "$FILE"

    echo "Scheduled to $target_date: <  $task_text"
}

# Show help
help() {
    cat <<'EOF'
bj - Minimal Bullet Journal

USAGE:
  bj                  List tasks
  bj [text]           Add task (default: .)
  bj [bullet] [text]  Add task with bullet
  bj [bullet] [n]     Change task n to bullet
  bj del [n]          Delete task n
  bj date today       Go to today
  bj date [date]      Go to specific date
  bj migrate          Migrate tasks to tomorrow
  bj schedule [n] [date]  Schedule task n to date

BULLETS:
  .  task     x  done      a  abandoned
  !  priority o  event     -  note
  w  waiting  >  migrated  <  scheduled

EXAMPLES:
  bj                  # List all tasks
  bj Buy milk         # Add task ". Buy milk"
  bj o Meeting at 3pm # Add event
  bj x 1              # Mark task 1 as done
  bj del 3            # Delete task 3
  bj date 12-25       # Go to Dec 25
  bj migrate          # Migrate to tomorrow
  bj schedule 2 12-25 # Schedule task 2 to Dec 25
EOF
}

# Main
if [[ $# -eq 0 ]]; then
    list
    exit 0
fi

case "$1" in
    -h|--help|help)
        help
        exit 0
        ;;
    del)
        if [[ $# -ne 2 ]]; then
            echo "Usage: bj del [n]"
            exit 1
        fi
        delete "$2"
        exit 0
        ;;
    date)
        if [[ $# -ne 2 ]]; then
            echo "Usage: bj date today | bj date MM-DD | bj date YYYY-MM-DD"
            exit 1
        fi
        navigate "$2"
        exit 0
        ;;
    migrate)
        if [[ $# -ne 1 ]]; then
            echo "Usage: bj migrate"
            exit 1
        fi
        migrate
        exit 0
        ;;
    schedule)
        if [[ $# -ne 3 ]]; then
            echo "Usage: bj schedule [n] [MM-DD | YYYY-MM-DD]"
            exit 1
        fi
        schedule "$2" "$3"
        exit 0
        ;;
    .)
        # bj . some task
        add . "${@:2}"
        exit 0
        ;;
    "!"|x|o|a|w|">"|"<"|-)
        # Could be: bj x 1 (change) or bj x some text (add)
        if [[ $# -eq 2 ]] && [[ "$2" =~ ^[0-9]+$ ]]; then
            change "$1" "$2"
        else
            add "$1" "${@:2}"
        fi
        exit 0
        ;;
    *)
        # bj some text - add as task
        add . "$@"
        exit 0
        ;;
esac
